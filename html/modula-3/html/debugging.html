<HTML>
<HEAD>
<TITLE>SRC Modula-3: Debugging</TITLE>
</HEAD>
<BODY BGCOLOR="#ffffff" VLINK="#006633">

<H2>Debugging</H2>
<P>

You must use <TT>m3gdb</TT> to debug code generated by SRC Modula-3.
It's a version of <TT>gdb</TT> that's been modified to understand
Modula-3 types, declarations, and expressions.  These modifications
are quite new.  Please report any problems to <TT>m3-request@src.dec.com</TT>.
<P>

When it's first started, you must explicitly tell <TT>m3gdb</TT> that it's
working on a Modula-3 program.  To do that type
<PRE>
    (m3gdb) set language m3
</PRE>
Similarly, if you need to access <TT>C</TT> procedures or variables
or do some kinds of low-level debugging, type
<PRE>
    (m3gdb) set language c
</PRE>
<P>

<H3>Procedures</H3>
<P>

Modula-3 procedures are mapped as closely as possible into C procedures.
Two differences exist:  ``large'' results and nested procedures.
<P>

First, procedures that return structured values (i.e. records, arrays
or sets) take an extra parameter.  The last parameter is a pointer to
the memory that will receive the returned result.  This parameter was
necessary because some C compilers return structured results by
momentarily copying them into global memory.  The global memory scheme
works fine until it's preempted by the Modula-3 thread scheduler.
<P>

Second, nested procedures are passed an extra parameter, the ``static link''.
The exact details of how that parameter are passed are system dependent.
<P>

<EM>I don't know how to call a nested procedure from the debugger's
  command line.</EM>
<P>

When a nested procedure is passed as a parameter, the address of the
corresponding C procedure and its extra parameter are packaged
into a small closure record.  The address of this record is actually
passed.  Any call through a formal procedure parameter first checks to
see whether the parameter is a closure or not and then makes the
appropriate call.  Likewise, assignments of formal procedure
parameters to variables perform runtime checks for closures.
<P>

<A HREF="pragmas.html"><TT>&lt;*EXTERNAL*&gt;</TT></A>
procedures have no extra parameters.
<EM> except if they return large results?? </EM>
<P>

<H3>Threads</H3>
<P>

<TT>m3gdb</TT> provides two commands to assist debugging multi-threaded
programs.
The command <B>threads</B>
lists the threads that exist in the program, with the first thread
being the most recently active one.
The command <B>switch n</B> switches the current context to the
thread identified as <TT>n</TT> by the <TT>threads</TT> command.
If you use the <TT>switch</TT> command, you <EM>must</EM> use it again to
switch back to the thread that was interrupted before
you can continue the execution of the program (i.e. the first thread
listed by the <TT>threads</TT> command).
If the <TT>switch</TT> command is interrupted, the state of
<TT>m3gdb</TT> is essentially random and it will most likely crash.
The current language must be <TT>m3</TT> for the <TT>threads</TT>
and <TT>switch</TT> commands to work.
<P>

There is no mechanism to run a single thread while keeping
all others stopped.
<P>

<A NAME="GC">
<H3>Garbage collection</H3>
</A>
<P>

Some platforms (eg DS3100 and SPARC) use a VM-synchronized
<A HREF="gc.html">garbage collector</A>.  On those platforms
will find it simplest to 
run it with the <A HREF="m3args.html"><TT>@M3novm</TT></A> switch.
For example, start your program with
<PRE>
    (m3gdb) run MyProgram @M3novm
</PRE>
<P>

If you do not use the <A HREF="m3args.html"><TT>@M3novm</TT></A> flag,
you must set <TT>m3gdb</TT>
to ignore VM faults generated on the collector's behalf, by typing 
<PRE>
    (m3gdb) handle 11 noprint pass
</PRE>
<P>
But then, without <A HREF="m3args.html"><TT>@M3novm</TT></A>,
you might not be able to examine the heap 
when the program stops, because the heap may be protected.  You can 
turn off all current heap protection by telling <TT>m3gdb</TT> 
<PRE>
    (m3gdb) call RTCollectorSRC.FinishVM()
</PRE>
<P>

If you also want the collector not to use VM protection in the future 
(i.e., if you wish you'd typed <A HREF="m3args.html"><TT>@M3novm</TT></A>
to start with), you can type 
<PRE>
    (m3gdb) call RTCollectorSRC.DisableVM()
</PRE>
<P>

If your program is not run from the debugger, and it dumps core, 
the runtime automatically calls the equivalent of
<TT>RTCollectorSRC.FinishVM()</TT>
to let you examine the heap in the core file.
<P>

<HR>
<A HREF="home.html">[Modula-3 home page]</A>
<P>
<A HREF="mailto:m3-request@src.dec.com">
<ADDRESS>m3-request@src.dec.com</ADDRESS></A>
<PRE>
Last modified on Thu Jan  4 11:08:08 PST 1996 by heydon 
     modified on Wed May  4 08:04:52 PDT 1994 by kalsow 
     modified on Thu Jan  7 18:40:57 PST 1993 by muller 
</PRE>

Copyright (C) 1992, 1996, Digital Equipment Corporation. All rights reserved.<BR>
See the <A HREF="http://www.research.digital.com/SRC/m3sources/html/COPYRIGHT.html">COPYRIGHT</A> for a full description.
</BODY>
</HTML>
